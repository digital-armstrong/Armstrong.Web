<% provide :page_title, "Приборы" %>
<% show_path = show_path.from(0).to(show_path.length-2) %>
<div class="row mx-0">
  <div class="col-2 ps-0">
    <div class="accordion mb-3" id="accordionFilter">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingFilter">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFilter" aria-expanded="true" aria-controls="collapseFilter">
            Фильтрация
          </button>
        </h2>
        <div id="collapseFilter" class="accordion-collapse collapse shadow" aria-labelledby="headingFilter" data-bs-parent="#accordionFilter">
          <%= search_form_for(@query, url:device_index_path, method: :get, class: "rounded accordion-body") do |f| %>
            <%= f.label :tabel_id, class:"mb-2"%>
            <%= f.search_field :tabel_id_eq, class: 'form-control', placeholder: 'Номер' %>
            <%= f.label :serial_id, class:"my-2" %>
            <%= f.search_field :serial_id_cont, class: 'form-control ', placeholder: 'Номер' %>
            <%= f.label :device_model_id, class:"my-2" %>
            <%= f.search_field :device_model_name_cont, class: 'form-control', placeholder: 'Название' %>
            <%= f.label :year_of_production, class:"my-2" %>
            <div class="row px-2">
              <div class="col px-1">
                <%= f.search_field :year_of_production_gteq, class: 'form-control', placeholder: 'От' %>
              </div>
              <div class="col px-1">
                <%= f.search_field :year_of_production_lteq, class: 'form-control', placeholder: 'До' %>
              </div>
            </div>
            <%= f.label :year_of_commissioning, class:"my-2" %>
            <div class="row px-2 mb-2">
              <div class="col px-1">
                <%= f.search_field :year_of_commissioning_gteq, class: 'form-control', placeholder: 'От' %>
              </div>
              <div class="col px-1">
                <%= f.search_field :year_of_commissioning_lteq, class: 'form-control', placeholder: 'До' %>
              </div>
            </div>
            <%= f.submit "Применить", class: 'btn btn-primary w-100'%>
          <% end %>
        </div>
      </div>
    </div>
    <%= render 'shared/modal_button_add', path: new_path %>
    <%= button_to device_download_path(request.params.merge(format: :pdf)), data: {turbo: :false}, class: "btn btn-primary my-3 w-100 shadow" do %>
      <i class="bi bi-download"></i><span> Скачать PDF</span>
    <% end %>
  </div>
  <div class="col-10 shadow rounded">
    <table class="table table-hover">
      <thead>
        <tr>
          <th scope="col">Таб. №</th>
          <th scope="col">Сер. №</th>
          <th scope="col">Модель</th>
          <th scope="col">Год выпуска</th>
          <th scope="col">Год ввода</th>
          <th scope="col">Дата инспекции</th>
          <th scope="col"><i class="bi bi-circle"></th>
        </tr>
      </thead>
      <tbody>
        <% @devices.each do |device| %>
          <% path = "#{show_path}#{device.id}" %>
          <tr onclick="document.location = `<%= path %>`" style="cursor:pointer">
            <% last_successful_inspection = device.inspections.where(state: "verification_successful").
            sort {|el| el.conclusion_date}.first %>
            <th scope="row"><%= device.tabel_id %></th>
            <td><%= device.serial_id %></td>
            <td><%= device.device_model.name %></td>
            <td><%= device.year_of_production %></td>
            <td><%= device.year_of_commissioning %></td>
            <td>
              <% if last_successful_inspection.present? %>
                <%= local_time(last_successful_inspection.conclusion_date, :date) %>
              <% end %>
            </td>
            <td><i class="bi bi-circle-fill text-danger"></i></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<div class="row my-5">
  <div class="col-2">
  </div>
  <div class="col-10">
    <div class="row">
      <div class="col"></div>
      <div class="col">
        <%= pagination @pagy %>
      </div>
      <div class="col"></div>
    </div>
  </div>
</div>
